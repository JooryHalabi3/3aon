<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Department Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: #f9fbfd;
            direction: rtl;
            color: #333;
            font-family: 'Tajawal', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #1e88e5;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .test-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .test-section h3 {
            color: #1e88e5;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .success { 
            background-color: #d4edda; 
            border-left: 4px solid #28a745;
        }
        
        .error { 
            background-color: #f8d7da; 
            border-left: 4px solid #dc3545;
        }
        
        .info { 
            background-color: #d1ecf1; 
            border-left: 4px solid #17a2b8;
        }

        button {
            background: #1565d8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #0d47a1;
            transform: translateY(-1px);
        }

        input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin: 5px;
            width: 200px;
        }

        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
            font-size: 12px;
            line-height: 1.4;
        }

        .login-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .login-form h3 {
            color: #1e88e5;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #1e88e5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 6px 6px 0;
        }

        .instructions h3 {
            color: #1e88e5;
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-right: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>اختبار إدارة القسم - Department Management Test</h1>
        </div>
        
        <div class="instructions">
            <h3>تعليمات الاختبار</h3>
            <ul>
                <li>تأكد من تشغيل الخادم على المنفذ 3001</li>
                <li>تأكد من وجود بيانات في قاعدة البيانات</li>
                <li>قم بتسجيل الدخول كمدير مرتبط بقسم معين</li>
                <li>استخدم هذه الصفحة لاختبار الوظائف</li>
            </ul>
        </div>

        <div class="login-form">
            <h3>تسجيل الدخول</h3>
            <div class="form-group">
                <label>البريد الإلكتروني أو اسم المستخدم:</label>
                <input type="text" id="loginIdentifier" placeholder="أدخل البريد الإلكتروني أو اسم المستخدم">
            </div>
            <div class="form-group">
                <label>كلمة المرور:</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button onclick="login()">تسجيل الدخول</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>اختبار الحصول على معلومات المستخدم</h3>
            <button onclick="testGetUserInfo()">اختبار /api/auth/me</button>
            <div id="userInfoResult"></div>
        </div>

        <div class="test-section">
            <h3>اختبار الحصول على موظفي القسم</h3>
            <button onclick="testGetDepartmentEmployees()">اختبار /api/admin/department/employees</button>
            <div id="employeesResult"></div>
        </div>

        <div class="test-section">
            <h3>اختبار الحصول على شكاوى القسم</h3>
            <button onclick="testGetDepartmentComplaints()">اختبار /api/admin/department/complaints</button>
            <div id="complaintsResult"></div>
        </div>

        <div class="test-section">
            <h3>اختبار تعيين شكوى</h3>
            <div class="form-group">
                <label>رقم الشكوى:</label>
                <input type="number" id="complaintId" placeholder="أدخل رقم الشكوى">
            </div>
            <div class="form-group">
                <label>رقم الموظف:</label>
                <input type="number" id="employeeId" placeholder="أدخل رقم الموظف">
            </div>
            <button onclick="testAssignComplaint()">اختبار تعيين الشكوى</button>
            <div id="assignResult"></div>
        </div>

        <div class="test-section">
            <h3>حالة التوكن</h3>
            <button onclick="checkTokenStatus()">فحص حالة التوكن</button>
            <div id="tokenStatus"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = isError ? 'error' : 'success';
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        function getToken() {
            return localStorage.getItem('token');
        }

        async function login() {
            try {
                const loginIdentifier = document.getElementById('loginIdentifier').value;
                const password = document.getElementById('password').value;

                if (!loginIdentifier || !password) {
                    showResult('loginResult', { error: 'يرجى إدخال بيانات تسجيل الدخول' }, true);
                    return;
                }

                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        loginIdentifier,
                        password
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    localStorage.setItem('token', data.data.token);
                    showResult('loginResult', { 
                        success: true, 
                        message: 'تم تسجيل الدخول بنجاح',
                        user: data.data.employee
                    });
                } else {
                    showResult('loginResult', data, true);
                }
            } catch (error) {
                showResult('loginResult', { error: error.message }, true);
            }
        }

        async function testGetUserInfo() {
            try {
                const token = getToken();
                if (!token) {
                    showResult('userInfoResult', { error: 'No token found. Please login first.' }, true);
                    return;
                }

                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                showResult('userInfoResult', data, !response.ok);
            } catch (error) {
                showResult('userInfoResult', { error: error.message }, true);
            }
        }

        async function testGetDepartmentEmployees() {
            try {
                const token = getToken();
                if (!token) {
                    showResult('employeesResult', { error: 'No token found. Please login first.' }, true);
                    return;
                }

                const response = await fetch(`${API_BASE}/admin/department/employees`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                showResult('employeesResult', data, !response.ok);
            } catch (error) {
                showResult('employeesResult', { error: error.message }, true);
            }
        }

        async function testGetDepartmentComplaints() {
            try {
                const token = getToken();
                if (!token) {
                    showResult('complaintsResult', { error: 'No token found. Please login first.' }, true);
                    return;
                }

                const response = await fetch(`${API_BASE}/admin/department/complaints`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                showResult('complaintsResult', data, !response.ok);
            } catch (error) {
                showResult('complaintsResult', { error: error.message }, true);
            }
        }

        async function testAssignComplaint() {
            try {
                const token = getToken();
                if (!token) {
                    showResult('assignResult', { error: 'No token found. Please login first.' }, true);
                    return;
                }

                const complaintId = document.getElementById('complaintId').value;
                const employeeId = document.getElementById('employeeId').value;

                if (!complaintId || !employeeId) {
                    showResult('assignResult', { error: 'Please enter both complaint ID and employee ID' }, true);
                    return;
                }

                const response = await fetch(`${API_BASE}/admin/complaints/${complaintId}/assign`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        employeeId: parseInt(employeeId),
                        reason: 'Test assignment from test page'
                    })
                });

                const data = await response.json();
                showResult('assignResult', data, !response.ok);
            } catch (error) {
                showResult('assignResult', { error: error.message }, true);
            }
        }

        function checkTokenStatus() {
            const token = getToken();
            if (token) {
                try {
                    // Decode token without verification to see its structure
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    showResult('tokenStatus', {
                        hasToken: true,
                        tokenStructure: payload,
                        expiresAt: new Date(payload.exp * 1000).toLocaleString()
                    });
                } catch (error) {
                    showResult('tokenStatus', { 
                        hasToken: true, 
                        error: 'Could not decode token',
                        token: token.substring(0, 50) + '...'
                    }, true);
                }
            } else {
                showResult('tokenStatus', { hasToken: false, message: 'No token found' }, true);
            }
        }

        // Check token status on page load
        window.onload = function() {
            checkTokenStatus();
        };
    </script>
</body>
</html>
