<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار استخراج التاريخ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>اختبار استخراج التاريخ من ملف الإكسل</h1>
    
    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button onclick="testDateExtraction()">اختبار استخراج التاريخ</button>
    
    <div id="result"></div>

    <script>
        // دالة استخراج التاريخ من أول سطر في ملف الإكسل
        function extractDateFromFirstRow(rawData) {
            if (!rawData || rawData.length === 0) {
                return ''; // لا توجد قيمة افتراضية
            }

            const firstRow = rawData[0];
            if (!firstRow || !Array.isArray(firstRow)) {
                return '';
            }

            console.log('First row:', firstRow);

            // البحث عن التاريخ في أول سطر
            for (let i = 0; i < firstRow.length; i++) {
                const cell = String(firstRow[i] || '').trim();
                console.log(`Cell ${i}: "${cell}"`);
                
                // البحث عن أنماط التاريخ العربية
                const arabicDatePatterns = [
                    /لسنة\s*(\d{4})\s*شهر\s*(\w+)/i,
                    /سنة\s*(\d{4})\s*شهر\s*(\w+)/i,
                    /(\d{4})\s*شهر\s*(\w+)/i,
                    /شهر\s*(\w+)\s*سنة\s*(\d{4})/i,
                    /شهر\s*(\w+)\s*(\d{4})/i
                ];

                // البحث عن أنماط التاريخ الإنجليزية
                const englishDatePatterns = [
                    /for\s*(\w+)\s*(\d{4})/i,
                    /(\w+)\s*(\d{4})/i,
                    /year\s*(\d{4})\s*month\s*(\w+)/i,
                    /month\s*(\w+)\s*year\s*(\d{4})/i
                ];

                // فحص الأنماط العربية
                for (const pattern of arabicDatePatterns) {
                    const match = cell.match(pattern);
                    if (match) {
                        const year = match[1] || match[2];
                        const month = match[2] || match[1];
                        console.log(`Found Arabic date pattern: year=${year}, month=${month}`);
                        return `لسنة ${year} شهر ${month}`;
                    }
                }

                // فحص الأنماط الإنجليزية
                for (const pattern of englishDatePatterns) {
                    const match = cell.match(pattern);
                    if (match) {
                        const year = match[1] || match[2];
                        const month = match[2] || match[1];
                        
                        // تحويل أسماء الأشهر الإنجليزية إلى العربية
                        const monthMap = {
                            'january': 'يناير', 'jan': 'يناير',
                            'february': 'فبراير', 'feb': 'فبراير',
                            'march': 'مارس', 'mar': 'مارس',
                            'april': 'أبريل', 'apr': 'أبريل',
                            'may': 'مايو',
                            'june': 'يونيو', 'jun': 'يونيو',
                            'july': 'يوليو', 'jul': 'يوليو',
                            'august': 'أغسطس', 'aug': 'أغسطس',
                            'september': 'سبتمبر', 'sep': 'سبتمبر',
                            'october': 'أكتوبر', 'oct': 'أكتوبر',
                            'november': 'نوفمبر', 'nov': 'نوفمبر',
                            'december': 'ديسمبر', 'dec': 'ديسمبر'
                        };
                        
                        const arabicMonth = monthMap[month.toLowerCase()] || month;
                        console.log(`Found English date pattern: year=${year}, month=${month} -> ${arabicMonth}`);
                        return `لسنة ${year} شهر ${arabicMonth}`;
                    }
                }

                // البحث عن أي نص يحتوي على سنة وأشهر
                if (cell.includes('2024') || cell.includes('2023') || cell.includes('2025')) {
                    const yearMatch = cell.match(/(\d{4})/);
                    const monthMatch = cell.match(/(يناير|فبراير|مارس|أبريل|مايو|يونيو|يوليو|أغسطس|سبتمبر|أكتوبر|نوفمبر|ديسمبر)/);
                    
                    if (yearMatch && monthMatch) {
                        console.log(`Found date in cell: year=${yearMatch[1]}, month=${monthMatch[1]}`);
                        return `لسنة ${yearMatch[1]} شهر ${monthMatch[1]}`;
                    }
                }
            }

            console.log('No date pattern found in first row');
            return ''; // لا توجد قيمة افتراضية
        }

        function testDateExtraction() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('الرجاء اختيار ملف إكسل');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log('Excel data:', jsonData);
                    
                    const extractedDate = extractDateFromFirstRow(jsonData);
                    
                    document.getElementById('result').innerHTML = `
                        <h3>نتيجة استخراج التاريخ:</h3>
                        <p><strong>التاريخ المستخرج:</strong> ${extractedDate}</p>
                        <h4>أول سطر في الملف:</h4>
                        <pre>${JSON.stringify(jsonData[0], null, 2)}</pre>
                    `;
                    
                } catch (error) {
                    console.error('خطأ في قراءة الملف:', error);
                    alert('خطأ في قراءة الملف: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
