<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار نظام حماية Super Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: 'Tajawal', sans-serif;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .user-card {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .role-1 { border-left: 4px solid #28a745; }
        .role-2 { border-left: 4px solid #ffc107; }
        .role-3 { border-left: 4px solid #6c757d; }
        
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Tajawal', sans-serif;
        }
        
        .protected-pages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .page-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-allowed { background: #28a745; }
        .status-denied { background: #dc3545; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <h1>🛡️ اختبار نظام حماية Super Admin</h1>
    
    <div class="test-section">
        <h2>1. معلومات المستخدم الحالي</h2>
        <button class="btn" onclick="checkCurrentUser()">فحص المستخدم الحالي</button>
        <div id="current-user-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. اختبار تسجيل الدخول</h2>
        <div>
            <h3>مستخدمين اختبار:</h3>
            <div class="user-info">
                <div class="user-card role-1">
                    <strong>Super Admin</strong><br>
                    Username: 12341<br>
                    Password: 123456<br>
                    RoleID: 1
                </div>
                <div class="user-card role-2">
                    <strong>Admin عادي</strong><br>
                    Username: admin<br>
                    Password: password<br>
                    RoleID: 2
                </div>
                <div class="user-card role-3">
                    <strong>موظف</strong><br>
                    Username: employee<br>
                    Password: password<br>
                    RoleID: 3
                </div>
            </div>
        </div>
        
        <div>
            <input type="text" id="username" placeholder="اسم المستخدم" value="12341">
            <input type="password" id="password" placeholder="كلمة المرور" value="123456">
            <button class="btn btn-success" onclick="testLogin()">تسجيل الدخول</button>
            <button class="btn btn-warning" onclick="logout()">تسجيل الخروج</button>
        </div>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. اختبار الوصول للصفحات المحمية</h2>
        <div class="protected-pages">
            <div class="page-card">
                <strong>superAdmin.html</strong>
                <span id="status-superAdmin" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('superAdmin.html')">اختبار</button>
            </div>
            <div class="page-card">
                <strong>complaint-tracking.html</strong>
                <span id="status-complaint-tracking" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('complaint-tracking.html')">اختبار</button>
            </div>
            <div class="page-card">
                <strong>logs.html</strong>
                <span id="status-logs" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('logs.html')">اختبار</button>
            </div>
            <div class="page-card">
                <strong>permissions.html</strong>
                <span id="status-permissions" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('permissions.html')">اختبار</button>
            </div>
            <div class="page-card">
                <strong>organizational-directory.html</strong>
                <span id="status-organizational-directory" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('organizational-directory.html')">اختبار</button>
            </div>
            <div class="page-card">
                <strong>recycle-bin.html</strong>
                <span id="status-recycle-bin" class="status-indicator status-unknown"></span>
                <br><button class="btn" onclick="testPageAccess('recycle-bin.html')">اختبار</button>
            </div>
        </div>
        <div id="page-access-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. اختبار API endpoints</h2>
        <button class="btn" onclick="testSuperAdminAPI()">اختبار Super Admin API</button>
        <button class="btn" onclick="testBackendProtection()">اختبار حماية الباك اند</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. اختبار شامل للنظام</h2>
        <button class="btn btn-success" onclick="runFullSystemTest()">تشغيل اختبار شامل</button>
        <div id="full-test-result" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001/api';
        
        function checkCurrentUser() {
            const resultDiv = document.getElementById('current-user-result');
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ لا يوجد توكن - لم يتم تسجيل الدخول';
                return;
            }
            
            resultDiv.className = 'result info';
            resultDiv.textContent = `✅ تم تسجيل الدخول:
اسم المستخدم: ${user.Username || 'غير محدد'}
الاسم الكامل: ${user.FullName || 'غير محدد'}
RoleID: ${user.RoleID || 'غير محدد'}
RoleName: ${user.RoleName || 'غير محدد'}
Email: ${user.Email || 'غير محدد'}
الدور: ${getRoleDescription(user.RoleID)}`;
        }

        function getRoleDescription(roleID) {
            switch(roleID) {
                case 1: return 'Super Admin (يمكن الوصول لجميع الصفحات)';
                case 2: return 'Admin عادي (ممنوع من صفحات Super Admin)';
                case 3: return 'موظف (ممنوع من صفحات Super Admin)';
                default: return 'غير محدد';
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('login-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ يرجى إدخال اسم المستخدم وكلمة المرور';
                return;
            }

            try {
                resultDiv.className = 'result info';
                resultDiv.textContent = '🔄 جاري تسجيل الدخول...';
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('token', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.employee));
                    
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `✅ تسجيل الدخول ناجح:
الاسم: ${data.data.employee.FullName}
RoleID: ${data.data.employee.RoleID}
RoleName: ${data.data.employee.RoleName}
الدور: ${getRoleDescription(data.data.employee.RoleID)}

${data.data.employee.RoleID === 1 ? 
    '🟢 يمكن الوصول لصفحات Super Admin' : 
    '🔴 ممنوع من صفحات Super Admin'}`;
                    
                    // تحديث معلومات المستخدم
                    checkCurrentUser();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ فشل تسجيل الدخول: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطأ: ${error.message}`;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            document.getElementById('login-result').className = 'result warning';
            document.getElementById('login-result').textContent = '⚠️ تم تسجيل الخروج';
            
            checkCurrentUser();
            
            // إعادة تعيين حالة الصفحات
            const statusElements = document.querySelectorAll('.status-indicator');
            statusElements.forEach(el => {
                el.className = 'status-indicator status-unknown';
            });
        }

        async function testPageAccess(pageName) {
            const resultDiv = document.getElementById('page-access-result');
            const statusElement = document.getElementById(`status-${pageName.replace('.html', '').replace('-', '-')}`);
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            resultDiv.className = 'result info';
            resultDiv.textContent = `🔄 اختبار الوصول لصفحة ${pageName}...`;
            
            try {
                // محاولة الوصول للصفحة
                const response = await fetch(`/superAdmin/${pageName}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    if (user.RoleID === 1) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `✅ نجح الوصول لصفحة ${pageName} - Super Admin`;
                        statusElement.className = 'status-indicator status-allowed';
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `⚠️ تم الوصول للصفحة لكن المستخدم ليس Super Admin! هذا خطأ في النظام`;
                        statusElement.className = 'status-indicator status-denied';
                    }
                } else if (response.status === 403) {
                    if (user.RoleID !== 1) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `✅ تم منع الوصول بشكل صحيح لصفحة ${pageName} - المستخدم ليس Super Admin`;
                        statusElement.className = 'status-indicator status-denied';
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent = `❌ تم منع Super Admin من الوصول! هذا خطأ في النظام`;
                        statusElement.className = 'status-indicator status-denied';
                    }
                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.textContent = `⚠️ استجابة غير متوقعة: ${response.status} ${response.statusText}`;
                    statusElement.className = 'status-indicator status-unknown';
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطأ في الاتصال: ${error.message}`;
                statusElement.className = 'status-indicator status-unknown';
            }
        }

        async function testSuperAdminAPI() {
            const resultDiv = document.getElementById('api-result');
            const token = localStorage.getItem('token');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ لا يوجد توكن - يجب تسجيل الدخول أولاً';
                return;
            }
            
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 اختبار Super Admin API endpoints...';
            
            const endpoints = [
                '/api/super-admin/employees',
                '/api/super-admin/system-stats',
                '/api/super-admin/recycle-bin'
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL.replace('/api', '')}${endpoint}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        results.push(`✅ ${endpoint}: نجح الوصول`);
                    } else if (response.status === 403) {
                        results.push(`🔴 ${endpoint}: تم المنع (403)`);
                    } else {
                        results.push(`⚠️ ${endpoint}: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    results.push(`❌ ${endpoint}: خطأ - ${error.message}`);
                }
            }
            
            resultDiv.className = 'result info';
            resultDiv.textContent = results.join('\n');
        }

        async function testBackendProtection() {
            const resultDiv = document.getElementById('api-result');
            
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 اختبار حماية الباك اند...';
            
            // اختبار بدون توكن
            try {
                const response = await fetch(`${API_BASE_URL}/super-admin/employees`);
                const noTokenResult = response.status === 401 ? 
                    '✅ تم منع الوصول بدون توكن (401)' : 
                    `❌ لم يتم منع الوصول بدون توكن: ${response.status}`;
                
                resultDiv.textContent = `نتائج اختبار حماية الباك اند:
${noTokenResult}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ خطأ في اختبار الحماية: ${error.message}`;
            }
        }

        async function runFullSystemTest() {
            const resultDiv = document.getElementById('full-test-result');
            resultDiv.className = 'result info';
            resultDiv.textContent = '🔄 تشغيل اختبار شامل للنظام...';
            
            let testResults = [];
            
            // اختبار 1: فحص المستخدم الحالي
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const token = localStorage.getItem('token');
            
            if (!token) {
                testResults.push('❌ اختبار 1: لا يوجد توكن');
            } else {
                testResults.push('✅ اختبار 1: يوجد توكن صالح');
            }
            
            // اختبار 2: فحص صحة التوكن مع الخادم
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        testResults.push('✅ اختبار 2: التوكن صالح مع الخادم');
                    } else {
                        testResults.push('❌ اختبار 2: التوكن غير صالح مع الخادم');
                    }
                } catch (error) {
                    testResults.push('❌ اختبار 2: خطأ في التحقق من التوكن');
                }
            }
            
            // اختبار 3: فحص RoleID
            if (user.RoleID === 1) {
                testResults.push('✅ اختبار 3: المستخدم Super Admin (RoleID = 1)');
            } else if (user.RoleID) {
                testResults.push(`🔴 اختبار 3: المستخدم ليس Super Admin (RoleID = ${user.RoleID})`);
            } else {
                testResults.push('❌ اختبار 3: RoleID غير محدد');
            }
            
            // اختبار 4: اختبار الوصول لصفحات محمية
            const protectedPages = ['superAdmin.html', 'logs.html', 'permissions.html'];
            for (const page of protectedPages) {
                try {
                    const response = await fetch(`/superAdmin/${page}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (user.RoleID === 1) {
                        if (response.ok) {
                            testResults.push(`✅ اختبار 4.${page}: Super Admin يمكنه الوصول`);
                        } else {
                            testResults.push(`❌ اختبار 4.${page}: Super Admin لا يمكنه الوصول!`);
                        }
                    } else {
                        if (response.status === 403) {
                            testResults.push(`✅ اختبار 4.${page}: تم منع المستخدم غير Super Admin`);
                        } else {
                            testResults.push(`❌ اختبار 4.${page}: لم يتم منع المستخدم غير Super Admin!`);
                        }
                    }
                } catch (error) {
                    testResults.push(`❌ اختبار 4.${page}: خطأ في الاختبار`);
                }
            }
            
            // عرض النتائج
            const successCount = testResults.filter(r => r.startsWith('✅')).length;
            const totalTests = testResults.length;
            
            resultDiv.className = successCount === totalTests ? 'result success' : 'result warning';
            resultDiv.textContent = `نتائج الاختبار الشامل (${successCount}/${totalTests}):

${testResults.join('\n')}

${successCount === totalTests ? 
    '🎉 جميع الاختبارات نجحت! النظام يعمل بشكل صحيح.' :
    '⚠️ بعض الاختبارات فشلت. يرجى مراجعة النظام.'}`;
        }

        // فحص أولي عند تحميل الصفحة
        window.addEventListener('load', function() {
            checkCurrentUser();
        });
    </script>
</body>
</html>
